#!/bin/bash

# #############################################################################
# Deploys a new app version by rebuilding the image and containers
# This file is managed by Ansible. Any changes may be overwritten.
# #############################################################################

function ensureSuccess {
  if [ $? -ne 0 ]; then
    echo "ERROR"
    exit 1
  fi
}

function printProgress {
  RED='\033[1;33m'
  NC='\033[0m'

  echo -e "${RED}$1${NC}"
}

WEB_CONTAINER="{{ app_name }}_web"
OLD_REV=${1:0:7}
NEW_REV=${2:0:7}
REFNAME=$3

cd {{ git_clone_path }}

# Reset to latest commit on branch
# This is effectively same as `git pull` but it
# correctly handles rollbacks via forced updates
git fetch origin
git reset --hard origin/{{ git_branch }}

printProgress "Building ${OLD_REV}..${NEW_REV} ($REFNAME)"

if [[ -n $(docker images -q $WEB_CONTAINER:${NEW_REV}) ]]; then
  printProgress "Image build ${WEB_CONTAINER}:${NEW_REV} already exists"
fi;

# Build images
printProgress "Building images"
docker-compose build
ensureSuccess

# Tag docker images with git SHA version
if [[ -z $(docker images -q $WEB_CONTAINER:${NEW_REV}) ]]; then
  printProgress "Tagging image build as ${WEB_CONTAINER}:${NEW_REV}"
  docker tag $WEB_CONTAINER:latest $WEB_CONTAINER:$NEW_REV
fi;

# Teardown current running containers
printProgress "Stopping current containers"
docker-compose down
ensureSuccess

# Cleanup dangling images
printProgress "Cleanup dangling images"
DANGLING_IMAGES=$(docker images -f "dangling=true" -q)
[[ -n $DANGLING_IMAGES ]] && docker rmi -f ${DANGLING_IMAGES}

# Recreate containers
printProgress "Recreating containers"
docker-compose up --no-start
ensureSuccess

# Run DB tasks
printProgress "Running: db:create"
docker-compose run --rm web bundle exec rake db:create
ensureSuccess
printProgress "Running: db:migrate"
docker-compose run --rm web bundle exec rake db:migrate
ensureSuccess
printProgress "Running: assets:precompile"
docker-compose run --rm web bundle exec rake assets:precompile
ensureSuccess

# Start services
printProgress "Starting containers"
docker-compose start
ensureSuccess
